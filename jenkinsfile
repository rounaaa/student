pipeline {
    agent any

    tools {
        maven 'maven'
        jdk 'jdk17'
    }

    environment {
        DOCKERHUB_CREDENTIALS = 'dockerhub'
        IMAGE_NAME = 'student-management-raouen'
        DOCKERHUB_USER = 'raouenmaknine'
        IMAGE_TAG = '1.0'
    }

    stages {
        stage('Clone repository') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/rounaaa/student.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn -B clean package'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }
        
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: "${DOCKERHUB_CREDENTIALS}",
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${DOCKER_USER}/${IMAGE_NAME}:${IMAGE_TAG}
                        docker logout
                    '''
                }
            }
        }

        
stage('Run Container') {
            steps {
                sh '''
                    docker stop student-app 2>/dev/null || true
                    docker rm student-app 2>/dev/null || true
                    docker run -d --name student-app -p 8081:8080 ${DOCKERHUB_USER}/${IMAGE_NAME}:${IMAGE_TAG}
                '''
            }
        }
stage('Deploy to Kubernetes') {
    steps {
        script {
            sh '''
                set +e  # Ne pas arr√™ter sur les erreurs
                
                echo "üîç Diagnostic Kubernetes..."
                
                # √âtape 1: V√©rifier les pr√©requis
                if [ ! -f "spring-deployment.yaml" ]; then
                    echo "‚ùå Fichier spring-deployment.yaml non trouv√©"
                    echo "üìÅ Contenu du r√©pertoire :"
                    ls -la
                    exit 1
                fi
                
                # √âtape 2: V√©rifier kubectl
                KUBECTL_PATH=$(which kubectl)
                if [ -z "$KUBECTL_PATH" ]; then
                    echo "‚ö†Ô∏è  kubectl non trouv√©, tentative d'installation..."
                    # Ajoutez ici l'installation adapt√©e √† votre environnement
                    echo "‚ùå Veuillez installer kubectl sur le node Jenkins"
                    exit 1
                else
                    echo "‚úÖ kubectl trouv√©: $KUBECTL_PATH"
                fi
                
                # √âtape 3: V√©rifier la connexion
                kubectl cluster-info 2>/dev/null
                if [ $? -ne 0 ]; then
                    echo "‚ö†Ô∏è  Impossible de se connecter au cluster Kubernetes"
                    echo "‚ÑπÔ∏è  V√©rifiez la configuration kubeconfig"
                    kubectl config view
                else
                    echo "‚úÖ Connect√© au cluster Kubernetes"
                fi
                
                # √âtape 4: D√©ployer
                echo "üöÄ D√©ploiement en cours..."
                
                # Cr√©er le namespace si n√©cessaire
                kubectl create namespace devops --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null || true
                
                # Appliquer avec plusieurs tentatives
                for i in {1..3}; do
                    echo "Tentative $i/3..."
                    kubectl apply -f spring-deployment.yaml -n devops --validate=false && {
                        echo "‚úÖ D√©ploiement r√©ussi"
                        break
                    }
                    sleep 5
                done
                
                # V√©rifier le r√©sultat
                echo "üìä √âtat final :"
                kubectl get pods -n devops 2>/dev/null || echo "Impossible de r√©cup√©rer les pods"
            '''
        }
    }
}

    }

}
